<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>天问计划week11-day7 | sixpar&#39;s blog</title>
  <meta name="keywords" content=" 天问计划 ">
  <meta name="description" content="天问计划week11-day7 | sixpar&#39;s blog">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="欢迎您的访问 想了解我？ 我只是某不知名的pwn手噢~">
<meta property="og:type" content="website">
<meta property="og:title" content="about">
<meta property="og:url" content="http://yoursite.com/about/index.html">
<meta property="og:site_name" content="sixpar&#39;s blog">
<meta property="og:description" content="欢迎您的访问 想了解我？ 我只是某不知名的pwn手噢~">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-07-02T13:45:54.000Z">
<meta property="article:modified_time" content="2020-07-04T03:37:23.628Z">
<meta property="article:author" content="sixpar">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/sunburst.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 4.2.1"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
</div>


<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>sixpar</span>
</div>

<div class="icon">
    
        
    
        
        <a title="github" href="https://github.com/ccjacoo" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=570791563&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"></use>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active" data-rel="All">All<small>(53)</small></div></li>
    
        
            
            <li><div data-rel="PWN题">PWN题<small>(16)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="笔记">笔记<small>(7)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="系列">系列<small>(19)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="生活">生活<small>(6)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="学习">学习<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="逆向题">逆向题<small>(1)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/about">About</a><a style="width: 50%"  class="friends">Friends</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="53">
<input type="hidden" id="yelog_site_word_count" value="95.1k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://47.107.81.38">sixpar的小站</a></li>
            
            <li><a target="_blank" href="http://v3ged4g.top">V3D4师傅</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" />
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Bypass-Canary</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>canary</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ctfwiki</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>DynELF</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>fd</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>gdb</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>heap</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>IO_File</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>IO缓冲区</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>partial_write</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>pyc反编译</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>reverse</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ROP</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>shellcode</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>tcache dup</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>UAF</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>webpwn</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>入门</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>关于我</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>内核</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>劫持函数</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>基础</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>天问计划</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>实验</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>延迟绑定</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>数组溢出</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>日记</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>格式化字串</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>汇编</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="All 系列 "
           href="/2020/08/04/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week12-day2/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week12-day2">天问计划week12-day2</span>
            <span class="post-date" title="2020-08-04 12:52:06">2020/08/04</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/08/03/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week12-day1/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week12-day1">天问计划week12-day1</span>
            <span class="post-date" title="2020-08-03 17:02:08">2020/08/03</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/08/02/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week11-day7/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week11-day7">天问计划week11-day7</span>
            <span class="post-date" title="2020-08-02 09:20:37">2020/08/02</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/08/01/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week11-day6/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week11-day6">天问计划week11-day6</span>
            <span class="post-date" title="2020-08-01 07:55:09">2020/08/01</span>
        </a>
        
        <a  class="All 生活 "
           href="/2020/08/01/2020-8-1%E5%B0%8F%E8%AE%B0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="2020-8-1小记">2020-8-1小记</span>
            <span class="post-date" title="2020-08-01 07:54:34">2020/08/01</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/31/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week11-day5/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week11-day5">天问计划week11-day5</span>
            <span class="post-date" title="2020-07-31 08:41:21">2020/07/31</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/30/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week11-day4/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week11-day4">天问计划week11-day4</span>
            <span class="post-date" title="2020-07-30 10:48:58">2020/07/30</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/29/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week11-day3/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week11-day3">天问计划week11-day3</span>
            <span class="post-date" title="2020-07-29 09:07:17">2020/07/29</span>
        </a>
        
        <a  class="All 生活 "
           href="/2020/07/28/2020-7-28%E5%B0%8F%E8%AE%B0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="2020-7-28小记">2020-7-28小记</span>
            <span class="post-date" title="2020-07-28 22:17:33">2020/07/28</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/28/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week11-day2/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week11-day2">天问计划week11-day2</span>
            <span class="post-date" title="2020-07-28 09:40:53">2020/07/28</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/27/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week11-day1/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week11-day1">天问计划week11-day1</span>
            <span class="post-date" title="2020-07-27 23:00:48">2020/07/27</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/26/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week10-day7/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week10-day7">天问计划week10-day7</span>
            <span class="post-date" title="2020-07-26 10:39:28">2020/07/26</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/25/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week10-day6/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week10-day6">天问计划week10-day6</span>
            <span class="post-date" title="2020-07-25 10:41:06">2020/07/25</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/24/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week10-day5/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week10-day5">天问计划week10-day5</span>
            <span class="post-date" title="2020-07-24 22:20:40">2020/07/24</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/23/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week10-day4/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划weeek10-day4">天问计划weeek10-day4</span>
            <span class="post-date" title="2020-07-23 23:11:16">2020/07/23</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/22/%E5%A4%A9%E9%97%AE%E8%AE%A1%E5%88%92week10-day3/"
           data-tag="天问计划"
           data-author="" >
            <span class="post-title" title="天问计划week10-day3">天问计划week10-day3</span>
            <span class="post-date" title="2020-07-22 22:12:41">2020/07/22</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/19/0day%E5%AE%89%E5%85%A8%E5%AE%9E%E9%AA%8C-2-4%E4%BB%A3%E7%A0%81%E6%A4%8D%E5%85%A5/"
           data-tag="实验"
           data-author="" >
            <span class="post-title" title="0day安全实验-2.4代码植入">0day安全实验-2.4代码植入</span>
            <span class="post-date" title="2020-07-19 20:27:06">2020/07/19</span>
        </a>
        
        <a  class="All 生活 "
           href="/2020/07/19/%EF%BC%88%E8%BD%AC%EF%BC%89%E6%B5%85%E8%B0%88%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E4%B8%8E%E7%97%85%E6%AF%92%E7%A0%94%E7%A9%B6/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="（转）浅谈二进制漏洞与病毒研究">（转）浅谈二进制漏洞与病毒研究</span>
            <span class="post-date" title="2020-07-19 15:08:34">2020/07/19</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/19/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cpwn%E8%BF%9B%E9%98%B6%E9%A2%98-stack2/"
           data-tag="ROP,数组溢出"
           data-author="" >
            <span class="post-title" title="攻防世界pwn进阶题-stack2">攻防世界pwn进阶题-stack2</span>
            <span class="post-date" title="2020-07-19 09:26:26">2020/07/19</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/18/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cpwn%E8%BF%9B%E9%98%B6%E9%A2%98-babyfengshui/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="攻防世界pwn进阶题-babyfengshui">攻防世界pwn进阶题-babyfengshui</span>
            <span class="post-date" title="2020-07-18 14:37:24">2020/07/18</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/17/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C%E8%BF%9B%E9%98%B6pwn%E9%A2%98-easypwn/"
           data-tag="格式化字串,partial_write"
           data-author="" >
            <span class="post-title" title="攻防世界进阶pwn题-easypwn">攻防世界进阶pwn题-easypwn</span>
            <span class="post-date" title="2020-07-17 21:19:04">2020/07/17</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/16/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cpwn%E8%BF%9B%E9%98%B6-easyfmt/"
           data-tag="格式化字串"
           data-author="" >
            <span class="post-title" title="攻防世界pwn进阶-easyfmt">攻防世界pwn进阶-easyfmt</span>
            <span class="post-date" title="2020-07-16 22:24:45">2020/07/16</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/16/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C%E5%88%9D%E9%98%B6%E5%9B%9E%E9%A1%BE/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="攻防世界初阶回顾">攻防世界初阶回顾</span>
            <span class="post-date" title="2020-07-16 16:24:59">2020/07/16</span>
        </a>
        
        <a  class="All 生活 "
           href="/2020/07/15/2020%E5%B9%B47%E6%9C%8815%E6%97%A5%E5%B0%8F%E8%AE%B0/"
           data-tag="日记"
           data-author="" >
            <span class="post-title" title="2020年7月15日小记">2020年7月15日小记</span>
            <span class="post-date" title="2020-07-15 22:07:29">2020/07/15</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/13/DynELF-L-CTF-2016-pwn100/"
           data-tag="DynELF,ROP"
           data-author="" >
            <span class="post-title" title="DynELF--L-CTF-2016-pwn100">DynELF--L-CTF-2016-pwn100</span>
            <span class="post-date" title="2020-07-13 14:39:51">2020/07/13</span>
        </a>
        
        <a  class="All 逆向题 "
           href="/2020/07/12/%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B2019-1-%E6%9D%A5%E7%8E%A9%E8%9B%87%E5%90%A7/"
           data-tag="reverse,pyc反编译"
           data-author="" >
            <span class="post-title" title="安恒月赛2019.1-来玩蛇吧">安恒月赛2019.1-来玩蛇吧</span>
            <span class="post-date" title="2020-07-12 23:12:05">2020/07/12</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/12/plaidctf-2013-ropasaurusrex-DynELF/"
           data-tag="DynELF,ROP"
           data-author="" >
            <span class="post-title" title="plaidctf-2013-ropasaurusrex(DynELF)">plaidctf-2013-ropasaurusrex(DynELF)</span>
            <span class="post-date" title="2020-07-12 22:13:50">2020/07/12</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/11/CISCN-2018-Quals-echo-back/"
           data-tag="格式化字串,IO_File"
           data-author="" >
            <span class="post-title" title="CISCN-2018-Quals  echo_back">CISCN-2018-Quals  echo_back</span>
            <span class="post-date" title="2020-07-11 23:22:35">2020/07/11</span>
        </a>
        
        <a  class="All 笔记 "
           href="/2020/07/09/dl-runtime-resolve%E5%87%BD%E6%95%B0%E8%BF%87%E7%A8%8B/"
           data-tag="延迟绑定"
           data-author="" >
            <span class="post-title" title="_dl_runtime_resolve函数过程">_dl_runtime_resolve函数过程</span>
            <span class="post-date" title="2020-07-09 10:01:47">2020/07/09</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/09/pwnable-tw-start/"
           data-tag="汇编,shellcode"
           data-author="" >
            <span class="post-title" title="pwnable.tw-start">pwnable.tw-start</span>
            <span class="post-date" title="2020-07-09 00:08:11">2020/07/09</span>
        </a>
        
        <a  class="All 笔记 "
           href="/2020/07/08/%E6%95%99%E4%BD%A0%E5%A6%82%E4%BD%95%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8/"
           data-tag="内核"
           data-author="" >
            <span class="post-title" title="教你如何编译内核">教你如何编译内核</span>
            <span class="post-date" title="2020-07-08 18:24:00">2020/07/08</span>
        </a>
        
        <a  class="All 学习 "
           href="/2020/07/07/IO%E7%BC%93%E5%86%B2%E5%8C%BA/"
           data-tag="IO缓冲区"
           data-author="" >
            <span class="post-title" title="IO缓冲区">IO缓冲区</span>
            <span class="post-date" title="2020-07-07 15:06:28">2020/07/07</span>
        </a>
        
        <a  class="All 学习 "
           href="/2020/07/07/file-descriptor%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/"
           data-tag="fd"
           data-author="" >
            <span class="post-title" title="file_descriptor文件描述符">file_descriptor文件描述符</span>
            <span class="post-date" title="2020-07-07 13:29:46">2020/07/07</span>
        </a>
        
        <a  class="All 生活 "
           href="/2020/07/06/%E4%B8%8B%E4%B8%80%E9%98%B6%E6%AE%B5%E8%A7%84%E5%88%92/"
           data-tag="关于我"
           data-author="" >
            <span class="post-title" title="下一阶段规划">下一阶段规划</span>
            <span class="post-date" title="2020-07-06 10:15:46">2020/07/06</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/05/X-MAS-CTF-web%E5%92%8Cpwn%E7%BB%93%E5%90%88/"
           data-tag="webpwn"
           data-author="" >
            <span class="post-title" title="X-MAS-CTF-web和pwn结合">X-MAS-CTF-web和pwn结合</span>
            <span class="post-date" title="2020-07-05 23:11:34">2020/07/05</span>
        </a>
        
        <a  class="All 学习 "
           href="/2020/07/05/%E4%BB%80%E4%B9%88%E6%98%AFweb-server/"
           data-tag="webpwn"
           data-author="" >
            <span class="post-title" title="什么是web_server">什么是web_server</span>
            <span class="post-date" title="2020-07-05 21:37:36">2020/07/05</span>
        </a>
        
        <a  class="All 生活 "
           href="/2020/07/05/%E7%94%9F%E6%B4%BB%E5%8C%BA%E5%BC%80%E7%AF%87/"
           data-tag="关于我"
           data-author="" >
            <span class="post-title" title="生活区开篇">生活区开篇</span>
            <span class="post-date" title="2020-07-05 16:07:45">2020/07/05</span>
        </a>
        
        <a  class="All 笔记 "
           href="/2020/07/05/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"
           data-tag="格式化字串"
           data-author="" >
            <span class="post-title" title="格式化字符串漏洞总结">格式化字符串漏洞总结</span>
            <span class="post-date" title="2020-07-05 14:48:42">2020/07/05</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/05/Bypass-Canary%E7%B3%BB%E5%88%97-%E5%8A%AB%E6%8C%81stack-chk-fail%E5%87%BD%E6%95%B0/"
           data-tag="Bypass-Canary,格式化字串,劫持函数"
           data-author="" >
            <span class="post-title" title="Bypass-Canary系列-劫持stack_chk_fail函数">Bypass-Canary系列-劫持stack_chk_fail函数</span>
            <span class="post-date" title="2020-07-05 10:00:41">2020/07/05</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/04/Bypass-Canary%E7%B3%BB%E5%88%97-one-by-one-%E7%88%86%E7%A0%B4/"
           data-tag="Bypass-Canary"
           data-author="" >
            <span class="post-title" title="Bypass-Canary系列-one-by-one-爆破">Bypass-Canary系列-one-by-one-爆破</span>
            <span class="post-date" title="2020-07-04 23:26:42">2020/07/04</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/04/Bypass-Canary%E7%B3%BB%E5%88%97-%E6%B3%84%E9%9C%B2Canary%E5%80%BC/"
           data-tag="Bypass-Canary,格式化字串"
           data-author="" >
            <span class="post-title" title="Bypass-Canary系列-泄露Canary值">Bypass-Canary系列-泄露Canary值</span>
            <span class="post-date" title="2020-07-04 18:32:52">2020/07/04</span>
        </a>
        
        <a  class="All 系列 "
           href="/2020/07/04/Bypass-Canary%E7%B3%BB%E5%88%97-%E7%B3%BB%E5%88%97%E4%BB%8B%E7%BB%8D/"
           data-tag="Bypass-Canary"
           data-author="" >
            <span class="post-title" title="Bypass-Canary系列-系列介绍">Bypass-Canary系列-系列介绍</span>
            <span class="post-date" title="2020-07-04 16:41:05">2020/07/04</span>
        </a>
        
        <a  class="All 笔记 "
           href="/2020/07/04/%E6%9F%A5%E7%9C%8B%E4%B8%80%E4%B8%AAELF%E6%96%87%E4%BB%B6%E7%9A%84%E4%BF%A1%E6%81%AF/"
           data-tag="基础"
           data-author="" >
            <span class="post-title" title="查看一个ELF文件的信息">查看一个ELF文件的信息</span>
            <span class="post-date" title="2020-07-04 14:58:18">2020/07/04</span>
        </a>
        
        <a  class="All 笔记 "
           href="/2020/07/04/ELF%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/"
           data-tag="基础"
           data-author="" >
            <span class="post-title" title="ELF保护机制">ELF保护机制</span>
            <span class="post-date" title="2020-07-04 14:33:16">2020/07/04</span>
        </a>
        
        <a  class="All 笔记 "
           href="/2020/07/03/PWN%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/"
           data-tag="入门"
           data-author="" >
            <span class="post-title" title="PWN入门基础">PWN入门基础</span>
            <span class="post-date" title="2020-07-03 13:05:08">2020/07/03</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/03/bjdctf-2020-babyrop2/"
           data-tag="ROP,canary"
           data-author="" >
            <span class="post-title" title="bjdctf_2020_babyrop2">bjdctf_2020_babyrop2</span>
            <span class="post-date" title="2020-07-03 12:47:06">2020/07/03</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/03/bjdctf-2020-babyrop/"
           data-tag="ROP"
           data-author="" >
            <span class="post-title" title="bjdctf_2020_babyrop">bjdctf_2020_babyrop</span>
            <span class="post-date" title="2020-07-03 12:40:13">2020/07/03</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/03/BJDCTF-2nd-ydsneedgirlfriend2/"
           data-tag="UAF,tcache dup"
           data-author="" >
            <span class="post-title" title="[BJDCTF 2nd]ydsneedgirlfriend2">[BJDCTF 2nd]ydsneedgirlfriend2</span>
            <span class="post-date" title="2020-07-03 12:22:23">2020/07/03</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/03/HITCON-training-hacknote-UAF/"
           data-tag="UAF,ctfwiki"
           data-author="" >
            <span class="post-title" title="HITCON-training-hacknote(UAF)">HITCON-training-hacknote(UAF)</span>
            <span class="post-date" title="2020-07-03 10:43:46">2020/07/03</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/03/2018%E9%A6%96%E5%B1%8A%E7%BD%91%E5%AE%89%E7%9C%81%E8%B5%9B-cont/"
           data-tag="heap"
           data-author="" >
            <span class="post-title" title="2018首届网安省赛 -cont">2018首届网安省赛 -cont</span>
            <span class="post-date" title="2020-07-03 09:04:04">2020/07/03</span>
        </a>
        
        <a  class="All 笔记 "
           href="/2020/07/03/gdb%E8%B0%83%E8%AF%95%E6%80%BB%E7%BB%93/"
           data-tag="gdb"
           data-author="" >
            <span class="post-title" title="gdb调试总结">gdb调试总结</span>
            <span class="post-date" title="2020-07-03 07:10:59">2020/07/03</span>
        </a>
        
        <a  class="All PWN题 "
           href="/2020/07/03/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E7%BD%91%E5%AE%89%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B-uninit/"
           data-tag="ROP"
           data-author="" >
            <span class="post-title" title="第二届浙江省网安竞赛初赛-uninit">第二届浙江省网安竞赛初赛-uninit</span>
            <span class="post-date" title="2020-07-03 01:15:23">2020/07/03</span>
        </a>
        
        <a  class="All "
           href="/2020/07/02/hello-world/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Hello World">Hello World</span>
            <span class="post-date" title="2020-07-02 20:49:04">2020/07/02</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-天问计划week11-day7" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">天问计划week11-day7</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="系列">系列</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color5">天问计划</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2020-08-02 22:24:39'>2020-08-02 09:20</time>
        
    </div>
    <div class="article-meta">
        
        <span>Count:5.1k</span>
        
        
        <span id="busuanzi_container_page_pv">
            Views 👀 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="跳转至评论区">
            <a href="#comments">
                Comment:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#学习："><span class="toc-text">学习：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#csapp书本第9章-虚拟内存："><span class="toc-text">csapp书本第9章-虚拟内存：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-lab："><span class="toc-text">malloc lab：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后"><span class="toc-text">最后</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="学习："><a href="#学习：" class="headerlink" title="学习："></a>学习：</h2><h4 id="csapp书本第9章-虚拟内存："><a href="#csapp书本第9章-虚拟内存：" class="headerlink" title="csapp书本第9章-虚拟内存："></a>csapp书本第9章-虚拟内存：</h4><p>物理寻址：直接给出一个有效的物理地址，然后CPU去主存寻址即可。</p>
<p>虚拟寻址：给出虚拟地址（VA），先转换（address translation）为物理地址，然后寻址。</p>
<p>VM系统将虚拟内存分割成大小固定的块，叫做虚拟页（VP）。物理内存也将被分割为物理页（PP），也称为页帧，物理页缓存在DRAM中。</p>
<p>虚拟页（VP）有三种状态：</p>
<ol>
<li>未分配的。VM系统还未分配创建的页，因此没有数据交互，所以不占用磁盘空间</li>
<li>未缓存的。还未缓存到物理页中去的已分配页</li>
<li>已缓存的。已经缓存到物理页中去的已分配页</li>
</ol>
<p>物理内存中有一个页表（page table）结构，存储着虚拟地址和物理地址之间的映射关系。常驻内存（DRAM）的页表。</p>
<p>操作系统负责维护页表，以及在磁盘和DRAM中来回传送页。</p>
<p>​        虚拟地址空间中的每个页在页表中一个固定偏移量处都有一个<code>PTE</code>。PTE由有效位和地址两部分组成。若设置了有效位，那么地址字段存储的就是DRAM中相应的物理页的起始地址。若未设置有效位，空地址则说明这个虚拟页还未被分配。</p>
<p>​        页命中：CPU想要读取某个虚拟内存（假如是VP2）中的一个字时，VP2刚好被缓存在了DRAM中，且页表中相对应的PTE也设置了有效位，所以也详细记载了VP2在物理内存中的起始地址，那么经过地址转换后就可以通过虚拟地址访问到物理地址，从而读取数据。一切都很顺利，便为页命中。</p>
<p>​        缺页：DRAM缓存不命中。假如CPU想要引用VP3，但是VP3并未缓存在DRAM中，地址翻译硬件从PTE3中发现有效位为0，因此并未缓存，于是从而触发了缺页异常。</p>
<p>​        缺页异常：由缺页导致的异常处理程序，程序会选择一个牺牲页（假如是VP4），假如VP4所处的位置是PP3，若VP4已经被修改过，那么就将它新数据复制回磁盘，更新嘛（若VP4未修改过那么就可以放心大胆覆盖了）。再接着，内核从从磁盘复制VP3到PP3（VP4原先待过的位置），然后更新PTE3，有效位置为1，并且地址填为PP3。因此VP4就不再在缓存中了，下一次访问VP4的时候就会触发缺页。缺页处理程序在返回时会把导致缺页的虚拟地址重新发送到地址翻译硬件。这回缓存中已经有VP3了，所以页命中，正常转换为物理地址。</p>
<p>​        页面调度：牺牲页，然后从磁盘或DRAM中换进换出页面。也称为交换。</p>
<p>​        分配页面：当调用malloc时，在磁盘上创建空间（假如是VP5），并更新PTE5，使其指向磁盘上的VP5 。</p>
<p>​        局部性（locality）：保证在任意时刻，程序将趋于在一个较小的活动页面集合上工作，这个集合叫做工作集（Working set）。在初始时就把工作集放入缓存，然后就尽量在这个工作集上引用，提高命中率，不产生额外的磁盘流量。</p>
<p>​        抖动：页面不断地换进换出。因为工作集大小超出了物理内存大小。</p>
<p>每次CPU生成一个地址时，地址翻译硬件都会读一个PTE。因此地址翻译硬件可以在PTE上额外添加一些许可位以达到访问控制目的，保护页面级的内存。具体做法是每个PTE的有效位变为了 SUP、READ、WRITE，地址字段保留。SUP位表示进程是否必须运行在内核（超级用户）模式下才能访问该页。因此普通用户只能访问SUP为0的页面。READ和WRITE自然就表示页的可读可写了。如果检测到有指令违反以上的许可条件的话，CPU就会触发一个保护故障，将控制传递给内核中的异常处理程序，Linux shell一般将这种异常报告为“段错误”（segment-fault）。</p>
<p>利用TLB加速地址翻译：在MMU（内存管理单元）中包含了一个关于PTE的一个小缓存，叫做翻译后备缓冲器（TLB）。TLB的每一行都保存着一个由单个PTE组成的块。用于组选择和行匹配的索引和标记字段都是从虚拟页号（VPN）中提取的。因此所有的地址翻译步骤都是在芯片的MMU中执行的，所以非常快。TLB命中的情况：CPU产生一个虚拟地址，MMU从TLB中取出对应的PTE，然后MMU将虚拟地址转换为物理地址然后发送给高速缓存/主存，缓存返回数据给CPU。  而当TLB不命中时，MMU必须从L1缓存中取出相应的PTE。（最好将PTE缓存在L1中）</p>
<p>fork是如何创建一个带有自己独立虚拟地址空间的新进程的？当fork函数被当前进程调用时，内核同等对待，为新进程创建各种数据结构，并分配一个PID，创建虚拟内存，创建当前进程的mm_struct、区域结构和页表的副本。内核将两个进程的每个页面都标记为只读，每个区域结构都标记为私有的写时复制。fork在新进程中返回时，新进程的虚拟内存和调用fork时存在的虚拟内存时相同的，当这两个进程任何一个后来进行写操作时，写时复制就会创建新页面。</p>
<p>execve函数是如何加装和执行程序的？调用了execve函数的形式为execve(“a.out”,NULL,NULL)。本质是用a.out程序文件替代了当前程序。具体步骤：1.删除已存在的用户区域结构；2.映射私有区域，为a.out文件映射test、data、bss、stack等新的区域结构；3.映射共享区域，若a.out与C库等有链接，则映射到用户虚拟地址空间中的共享区域内（处于栈和堆之间）；4.设置上进程下文的程序计数器，使之指向代码区域的入口点，执行第一句代码。等下一次调度这个进程时，它从这个入口点开始执行，然后换入代码和数据页面。</p>
<p>使用mmap创建新的虚拟内存区域，完成用户级内存映射：</p>
<pre><code class="c">#include &lt;unistd.h&gt;
#include &lt;sys/mman.h&gt;

void *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offset);</code></pre>
<p>首先fd指针指向磁盘中某文件（一个连续的片，也称为chunk）。然后mmap函数要求内核创建一个新的虚拟内存区域，最好是从地址*start处开始的一个区域，并将fd指向的chunk映射到这个新的区域。连续的片的大小是length字节。而这部分内容是从文件本身开始处偏移为offset字节的内容。start地址通常被设置为NULL。</p>
<p>参数prot描述新映射的虚拟内存区域的访问权限位。关于 prot参数，有以下选择：PROT_EXEC表示这个区域的页面可以被CPU执行的指令组成; PROT_READ表示页面可读 ;PROT_WRITE表示页面可写; PROT_NONE表示页面不能访问（自闭了）;</p>
<p>参数flags描述被映射对象类型的位组成。MAP_ANON表示匿名对象。 MAP_PRIVATE表示私有的、写时复制的对象。 MAP_SHARED表示共享对象。</p>
<p>举例：</p>
<blockquote>
<p>bufp = mmap(NULL,size,PROT_READ,MAP_PRIVATE,0,0)</p>
</blockquote>
<p>表示让内核创建一个包含size字节的只读、私有、请求二进制零的虚拟内存区域，如果成功，则bufp中存储新区域的地址。</p>
<p>动态内存分配器。C标准库中的 malloc 是显式分配器。通过调用malloc来在堆中分配块（chunk）：</p>
<pre><code class="c">#include &lt;stdlib.h&gt;

void *malloc(size_t size);       //若成功则返回指向新chunk的指针。出错则返回NULL</code></pre>
<p>对齐问题：对齐依赖于编译代码是32位（gcc -m32）还是64位的。在32位模式中，malloc返回的块的地址总是8的倍数，64位中是16的倍数。</p>
<p>malloc不初始化它返回的内存。要想初始化得用calloc函数，它将分配的内存初始化为0。而然realloc函数则是重新改变一个目前已分配块的大小。</p>
<p>free函数： void free(void *ptr) ，ptr参数必须指向由malloc，calloc，realloc函数分配的内存堆块的起始位置。</p>
<p>malloc与free的例子：</p>
<p><img src="https://i.loli.net/2020/08/02/nYeWxpUi8NdJz9r.jpg" alt=""></p>
<p>可以发现p2的指针在free之后仍然存在。申请p4的时候申请到了原先p2所在的空间。</p>
<p>为什么要动态分配内存？因为如果硬编码数组的界限的话，是固定死的，不能适用于所有情况。所以就需要动态地分配。</p>
<p>可以进行一下比较：</p>
<pre><code class="c">//其他代码我都省略了，就只比较关键的代码
//1.固定数组大小：
#define MAX 15213
int array[MAX];
for(i=0;i&lt;n;i++){
    scanf(&quot;%d&quot;,&amp;array[i]);
}    
//可以看到数组大小是固定死的。

//2.动态分配数组大小：
int *array,i,n;
scanf(&quot;%d&quot;,&amp;n);   //自定义数组大小
array=(int *)Malloc(n * sizeof(int));  //数组内存时动态分配的
for(i=0;i&lt;n;i++){
    scanf(&quot;%d&quot;,&amp;array[i]);
}
</code></pre>
<p>内部碎片：已分配块的大小大于它们有效载荷的大小。什么意思呢，就像上图中的9-34b那样，由于需要进行双字对齐，原本只申请了5字（有效载荷），现在多出了1字（内部碎片）用于对齐。</p>
<p>外部碎片：空闲内存为了满足某申请需求而进行切割，剩下的一部分由于太小无法满足其他需求而形成碎片。若整合起来的话还是可以分配出去的，可惜是分散着的。</p>
<h2 id="malloc-lab："><a href="#malloc-lab：" class="headerlink" title="malloc lab："></a>malloc lab：</h2><p>we need modifying and handing mm.c file</p>
<p>需要实现四个函数：</p>
<blockquote>
<p>int mm_init(void)</p>
<p>void *mm_malloc(size_t size);</p>
<p>void mm_free(void *ptr);</p>
<p>void *mm_realloc(void *ptr,size_t size);</p>
</blockquote>
<p>要求双字对齐。不允许更改 mm.c 中的 interface（也就是函数定义），不允许直接使用 malloc/calloc/free/realloc/sbrk/brk… 实际上可以用的给我们在 memlib.h 中，也就是文档中 Support Routines 指出的可以用的函数</p>
<p>参考代码：（原本想把每个函数分开来的，但是破坏了代码的整体性和关联性）</p>
<pre><code class="c">/*
 * mm-naive.c - The fastest, least memory-efficient malloc package.
 * 
 * In this naive approach, a block is allocated by simply incrementing
 * the brk pointer.  A block is pure payload. There are no headers or
 * footers.  Blocks are never coalesced or reused. Realloc is
 * implemented directly using mm_malloc and mm_free.
 *
 * NOTE TO STUDENTS: Replace this header comment with your own header
 * comment that gives a high level description of your solution.
 */
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;assert.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;

#include &quot;mm.h&quot;
#include &quot;memlib.h&quot;

/*********************************************************
 * NOTE TO STUDENTS: Before you do anything else, please
 * provide your team information in the following struct.
 ********************************************************/
/*
free chunk的结构

    +-------------+
    | chunksize|00|   &lt;- chunk size 包含两个标志位，表示当前chunk以及上一个chunk是否使用
    +-------------+
    |       fd    |   &lt;- 用户所使用的空间，包括对齐的空间。该空间以8字节为对齐标准
    |       bk    |
    |   (padding) |
    +-------------+
    |  chunksize  |   &lt;- chunk size，无标志位，可空间复用
    +-------------+
*/


/* single word (4) or double word (8) alignment */
#define ALIGNMENT 8
/* rounds up to the nearest multiple of ALIGNMENT */
#define ALIGN(size) (((size) + (ALIGNMENT-1)) &amp; ~0x7)
#define SIZE_T_SIZE (ALIGN(sizeof(size_t)))

#define WSIZE           4
#define DSIZE           (2*WSIZE)
#define MIN_CHUNKSIZE   4*WSIZE
#define CHUNKSIZE       0

/* Pack a size and allocated bit into a word. */
#define ALLOC_MASK      1
#define PREV_FREE_MASK  2
//#define PACK(size, alloc, prev_free) ((size) | (alloc) | (prev_free))

/* Read and write a word at address p */
#define GET(p)              (*(unsigned int*)(p))

/* Read the size and allocate fields form address p */
/* 此时的p应指向chunk头部 */

#define GET_RAW_SIZE(p)         (GET(p))
#define GET_SIZE(p)             (GET_RAW_SIZE(p) &amp; ~0x7)
#define GET_PREV_SIZE(p)        (GET_SIZE((p) - WSIZE))
// 这里的SET_SIZE将会保留最后2位
#define SET_SIZE(p, val)        (GET_RAW_SIZE(p) = (val | (GET_RAW_SIZE(p) &amp; (ALLOC_MASK | PREV_FREE_MASK))))


#define GET_ALLOC(p)                (GET_RAW_SIZE(p) &amp; ALLOC_MASK)
#define SET_ALLOC(p)                (GET_RAW_SIZE(p) |= ALLOC_MASK)
#define SET_FREE(p)              (GET_RAW_SIZE(p) &amp;= ~ALLOC_MASK)

#define GET_PREV_FREE(p)     (GET_RAW_SIZE(p) &amp; PREV_FREE_MASK ) 
#define SET_PREV_FREE(p)            (GET_RAW_SIZE(p) |= PREV_FREE_MASK ) 
#define SET_PREV_ALLOC(p)          (GET_RAW_SIZE(p) &amp;= ~PREV_FREE_MASK ) 

#define getListIndx(chunkSize) \
    ((chunkSize) &gt;= (1 &lt;&lt; 12) ? 8 :  \
    ((chunkSize) &gt;= (1 &lt;&lt; 11) ? 7 :  \
    ((chunkSize) &gt;= (1 &lt;&lt; 10) ? 6 :  \
    ((chunkSize) &gt;= (1 &lt;&lt; 9) ? 5 :   \
    ((chunkSize) &gt;= (1 &lt;&lt; 8) ? 4 :   \
    ((chunkSize) &gt;= (1 &lt;&lt; 7) ? 3 :   \
    ((chunkSize) &gt;= (1 &lt;&lt; 6) ? 2 :   \
    (chunkSize) &gt;= (1 &lt;&lt; 5) ? 1 :    \
    (chunkSize) &gt;= (1 &lt;&lt; 4) ? 0 : -1 \
    )))))))


// footer可以空间复用
#define request2chunksize(size) \
     ((size) &gt; (MIN_CHUNKSIZE - WSIZE) ? ALIGN(size+WSIZE) : MIN_CHUNKSIZE)

#define FD(p)           (*(void**)((void*)(p) + WSIZE))
// 传入指向fd的指针，传出指向该chunk的header的指针
#define FD2HD(p)        ((void*)((void*)(p) - WSIZE))
#define BK(p)           (*(void**)((void*)(p) + DSIZE))
#define NEXT_CHUNK(p)   ((void*)((void*)(p) + GET_SIZE(p)))
// PREV_CHUNK当且仅当上一个chunk是free chunk才能使用
#define PREV_CHUNK(p)   (((void*)(p) - GET_PREV_SIZE(p)))
#define FOOTER(p)       (NEXT_CHUNK(p) - WSIZE)
#define HD2MEM(p)       ((void*)((void*)(p) + WSIZE))
#define MEM2HD(p)       (FD2HD(p))


// debug专用宏定义
#define DBG(s) assert(s)
// 输出block里的数据(传入的是mem指针)
#define PRINT_BLOCK
#ifndef PRINT_BLOCK
#define PRINT_BLOCK(ptr, size, msg)        \
    printf(&quot;\n\n&quot;msg&quot;:\n&quot;);                 \
    for(size_t i = 0; i &lt; size; i++)        \
        printf(&quot;%02x &quot;, *(((char*)ptr) + i));  \
    printf(&quot;\n\n&quot;);
#endif
/*
ChunkSize:

0x10-0x20       2^4 - 2^5
0x20-0x40       2^5
0x40-0x80       2^6
0x80-0x100      2^7
0x100-0x200     2^8
0x200-0x400     2^9
0x400-0x800     2^106
0x800-0x1000    2^11
0x1000-~        2^12

9 bins(void*)
*/
#define HEAP_LIST_NUM 9
void* heap_listp[HEAP_LIST_NUM][2];
// top_chunk指向的chunk不存在heap_listp中，同时其指向的chunk一定在堆的最高
void* top_chunk = NULL;


// 将chunk从原来的list中断开
void unlink_chunk(void* chunk)
{
    void* bk = BK(chunk);
    void* fd = FD(chunk);
    DBG((bk &amp;&amp; fd) &amp;&amp; &quot;unlink_chunk: bk fd 不可能为空&quot;);
    FD(bk) = fd;
    BK(fd) = bk;
}

// 空闲内存合并
// 该函数会修改传入chunk的footer
static void* coalesce(void* chunk)
{
    int chunksize = GET_SIZE(chunk);
    DBG(chunksize &gt;= MIN_CHUNKSIZE &amp;&amp; &quot;coalesce: chunk大小不可能小于最小值&quot;);

    int* newptr = chunk;
    // 向前合并
    if(GET_PREV_FREE(chunk))
    {
        // 被合并的那个chunk要从原来的list链上断开
        void* prevChunk = PREV_CHUNK(chunk);
        unlink_chunk(prevChunk);
        int prev_chunksize = GET_PREV_SIZE(chunk);

        chunksize += prev_chunksize;
        newptr = prevChunk;
    }
    // 向后合并（排除当前chunk是top_chunk
    if(!GET_ALLOC(NEXT_CHUNK(chunk)) &amp;&amp; chunk != top_chunk &amp;&amp; NEXT_CHUNK(chunk) != top_chunk)
    {
        chunksize += GET_SIZE(NEXT_CHUNK(chunk));
        unlink_chunk(NEXT_CHUNK(chunk));
    }

    // 重新设置chunk的header与footer。只设置了大小，没有修改任何标志位
    SET_SIZE(newptr, chunksize);
    SET_SIZE(FOOTER(newptr), chunksize);
    return newptr;
}


static void* extend_heap(size_t words)
{
    void* bp;
    size_t size;

    // DSIZE对齐
    size = (words % 2) ? (words + 1) * WSIZE : words * WSIZE;
    if((long)(bp = mem_sbrk(size)) == -1)
        return NULL;

    return bp;
}

/* 
 * mm_init - initialize the malloc package.
 */
int mm_init(void)
{
    // 初始化链表
    for(int i = 0; i &lt; HEAP_LIST_NUM; i++)
    {
        void* headPtr = FD2HD(&amp;heap_listp[i][0]);
        FD(headPtr) = headPtr;
        BK(headPtr) = headPtr;
    }
    // 将brk抬高4字节，这样每个chunk的用户空间就满足八字节对齐标准
    // 同时，设置top chunk
    int topSize = (CHUNKSIZE &gt; MIN_CHUNKSIZE ? CHUNKSIZE : MIN_CHUNKSIZE);
    top_chunk = mem_sbrk(4 + topSize) + 4;
    SET_SIZE(top_chunk, topSize);
    SET_FREE(top_chunk);
    // 第一个chunk，设置前面的空间为不可合并
    SET_PREV_ALLOC(top_chunk);

    return 0;
}
// 在使用该函数前需要先设置size
void insertChunk2List(void* chunk)
{
    // 在插入前先对周围的内存块进行合并
    chunk = coalesce(chunk);
    DBG(!GET_ALLOC(chunk) &amp;&amp; &quot;insertChunk2List: 所插入的块，不可能是已经分配了的块&quot;);
    // 插入剩余的块到链表中
    int size = GET_SIZE(chunk);
    int listIdx = getListIndx(size);
    DBG(listIdx &gt;= 0 &amp;&amp; &quot;insertChunk2List: listIdx出错，chunkSize可能存在问题&quot;);
    void* headPtr = FD2HD(&amp;heap_listp[listIdx][0]);
    void * ptr = FD(headPtr);

    // 从list里的第一个chunk开始，从前到后遍历，遍历回list则停止
    // 注意，当list里一个chunk都没有时仍然成立
    while(ptr != headPtr &amp;&amp; GET_SIZE(ptr) &lt; size)
        ptr = FD(ptr);
    // 找到插入点
    FD(chunk) = ptr;
    BK(chunk) = BK(ptr);

    FD(BK(ptr)) = chunk;
    BK(ptr) = chunk;
}

// 传入的targetChunk必须是一块已经断开链表， 同时有意分配给用户的free chunk，
// 返回的是一块切剩下的空闲chunk, 其中已经设置相关的标志位
void* splitChunk(void* targetChunk, size_t targetChunksize)
{
    int current_chunkSize = GET_SIZE(targetChunk);
    int remainSize = current_chunkSize - targetChunksize;
    DBG(remainSize &gt;= MIN_CHUNKSIZE &amp;&amp; &quot;splitChunk: chunk过小，无法切割&quot;);
    // SET_SIZE足够精巧，以至于能保存上一个chunk的INUSE_BIT
    SET_SIZE(targetChunk, targetChunksize);
    SET_ALLOC(targetChunk);
    // 设置剩余chunk的size
    void* remainChunk = NEXT_CHUNK(targetChunk);
    SET_SIZE(remainChunk, remainSize);
    SET_FREE(remainChunk);
    SET_PREV_ALLOC(remainChunk);

    SET_SIZE(FOOTER(remainChunk), remainSize);
    // 将剩余的chunk插入至适合的位置
    return remainChunk;
}
/* 
 * mm_malloc - Allocate a block by incrementing the brk pointer.
 *     Always allocate a block whose size is a multiple of the alignment.
 */
void *mm_malloc(size_t size)
{
    void* targetMemPtr = NULL;
    int targetChunksize = request2chunksize(size);
    // 查找链表中是否存在需要的chunk
    for(int listIdx = getListIndx(targetChunksize); listIdx &lt; HEAP_LIST_NUM; listIdx++)
    {
        // 如果当前遍历到的链表非空，并且该链条中最大的chunk不小于所申请空间的大小，有机会，于是开始遍历
        if(heap_listp[listIdx][0] != FD2HD(&amp;heap_listp[listIdx][0]) 
            &amp;&amp; GET_SIZE(heap_listp[listIdx][1]) &gt;= targetChunksize)
        {
            // 遍历向下查找
            void* ptr = heap_listp[listIdx][0];   //该ptr指向某个chunk
            while(GET_SIZE(ptr) &lt; targetChunksize)
                ptr = FD(ptr);   //下一链表
            // 当跳出循环时表明此时已经获取到了所需要的chunk（第一个满足申请需求），但还需要判断是否应做切割处理
            int current_chunkSize = GET_SIZE(ptr);  //先获取当前链表chunk的size

            int remainSize = current_chunkSize - targetChunksize;   //切割剩余部分的chunk的size
            // 先断开链表   
            unlink_chunk(ptr);  
            if(remainSize &gt;= MIN_CHUNKSIZE)
            {
                void* remainChunk = splitChunk(ptr, targetChunksize);  //指向经过切割(splitchunk函数)后剩余的chunk的指针
                insertChunk2List(remainChunk);  //入链
            }
            else
            {
                // 设置目标chunk的header
                SET_SIZE(ptr, current_chunkSize);
                SET_ALLOC(ptr);
                SET_PREV_ALLOC(NEXT_CHUNK(ptr));
            }
            // 返回用户空间
            DBG(GET_ALLOC(ptr) &amp;&amp; &quot;mm_malloc: bad alloc status&quot;);
            targetMemPtr = HD2MEM(ptr);   //根据申请得到的chunk的header指针获取对应的mem指针
            return targetMemPtr;  //返回申请的chunk的mem指针
        }
    }

    // 如果所有的链表中的chunk都不满足，则需要向top chunk申请
    DBG(top_chunk &amp;&amp; &quot;mm_malloc： top_chunk不可能为空&quot;);
    // 必须保证top_chunk在任何情况下都有空间
    if(GET_SIZE(top_chunk) &gt;= targetChunksize + MIN_CHUNKSIZE)
    {
        void* ptr = top_chunk;
        top_chunk = splitChunk(ptr, targetChunksize);
        DBG(GET_ALLOC(ptr) &amp;&amp; &quot;mm_malloc: bad alloc status&quot;);
        return HD2MEM(ptr);
    }

    // 如果所有的chunk都不满足，则需要向brk申请
    int extend_size = (targetChunksize + MIN_CHUNKSIZE &gt; CHUNKSIZE ? 
        targetChunksize + MIN_CHUNKSIZE : CHUNKSIZE);      //extend_size可能取0
    void* extend_ptr = extend_heap(extend_size / WSIZE);   //extend_ptr可能取0

    // 如果没内存了，则返回空
    if(!extend_ptr)   //extend_ptr为0时返回NULL
        return NULL;
    SET_SIZE(extend_ptr, extend_size);
    SET_FREE(extend_ptr);
    SET_PREV_ALLOC(extend_ptr);
    // 将旧的top chunk放回链表中
    DBG(GET_SIZE(top_chunk) &gt;= MIN_CHUNKSIZE &amp;&amp; &quot;mm_malloc: chunk大小不可能小于最小值&quot;);
    insertChunk2List(top_chunk);
    top_chunk = extend_ptr;
    // 再次查找
    targetMemPtr = mm_malloc(size);   //递归
    //printf(&quot;address: %p, chunkSize: %x, reqSize: %x\n&quot;, 
      //  targetMemPtr, targetChunksize, size);
    return targetMemPtr;
}

/*
 * mm_free - Freeing a block does nothing.
 */
void mm_free(void *bp)
{
    void* chunk = MEM2HD(bp);
    DBG(GET_ALLOC(chunk) &amp;&amp; &quot;mm_free: double Free detected&quot;);
    SET_FREE(chunk);
    SET_PREV_FREE(NEXT_CHUNK(chunk));
    DBG(GET_SIZE(chunk) &gt;= MIN_CHUNKSIZE &amp;&amp; &quot;mm_free: chunk大小不可能小于最小值&quot;);
    insertChunk2List(chunk);
}

/*
 * mm_realloc - Implemented simply in terms of mm_malloc and mm_free
 */
// realloc要额外优化，否则最后两个样例会跑不通
void *mm_realloc(void *ptr, size_t size)
{
    DBG(GET_ALLOC(MEM2HD(ptr)) &amp;&amp; &quot;mm_realloc: double free / UAF detected&quot;);
    //return NULL;
    /*
        void* newp = mm_malloc(size);
        if(newp == NULL)
            return NULL;
        memcpy(newp, ptr, size);
        mm_free(ptr);
        return newp;
    */

   // oldptr 和 newptr始终指向chunk的header，而不是mem
    void* oldptr = MEM2HD(ptr);
    void* newptr = oldptr;
    size_t targetChunkSize = request2chunksize(size);
    // 确定要复制的字节数，避免越界读取
    size_t copySize = GET_SIZE(oldptr) - WSIZE;
    if (size &lt; copySize)
        copySize = size;

    PRINT_BLOCK(ptr, copySize, &quot;Before realloc:&quot;);

    // 先合并可能存在的空闲块, 并设置为已分配
    // 这里的合并操作不能使用coalesce，因为这个函数是面向空闲内存的，而oldptr并非空闲
    // newptr = coalesce(oldptr);

    int chunksize = GET_SIZE(oldptr);

    // 向前合并
    if(GET_PREV_FREE(oldptr))
    {
        void* prevChunk = PREV_CHUNK(oldptr);
        unlink_chunk(prevChunk);
        int prev_chunksize = GET_PREV_SIZE(oldptr);
        chunksize += prev_chunksize;
        newptr = prevChunk;
    }
    // 向后合并
    if(!GET_ALLOC(NEXT_CHUNK(oldptr)) &amp;&amp; NEXT_CHUNK(oldptr) != top_chunk)
    {
        chunksize += GET_SIZE(NEXT_CHUNK(oldptr));
        unlink_chunk(NEXT_CHUNK(oldptr));
    }

    // 设置大小
    SET_SIZE(newptr, chunksize);
    // 设置被分配
    SET_ALLOC(newptr);

    // 如果合并后的大小仍然不够
    if(chunksize &lt; targetChunkSize)
    {
        oldptr = newptr;
        // 分配一块新的
        void* newmem = mm_malloc(size);
        if (newmem == NULL)
            return NULL;
        newptr = MEM2HD(newmem);
        // 复制用户区域
        memcpy(newmem, HD2MEM(oldptr), copySize);
        // 同时释放之前那块
        mm_free(HD2MEM(oldptr));

        PRINT_BLOCK(HD2MEM(newptr), copySize, &quot;new alloc:&quot;);
    }
    // 如果可以使用
    else
    {
        // 如果不是原来的内存
        if(newptr != oldptr)
        {
            // 复制用户区域
            PRINT_BLOCK(HD2MEM(newptr), copySize, &quot;Before copy newptr :&quot;);
            PRINT_BLOCK(HD2MEM(oldptr), copySize, &quot;Before copy oldptr :&quot;);
            // 注意这里需要使用memmove，而不是memcpy，因为新的chunk和原来的chunk之间会存在重叠（正常现象）
            memmove(HD2MEM(newptr), HD2MEM(oldptr), copySize);
            PRINT_BLOCK(HD2MEM(newptr), copySize, &quot;After copy:&quot;);
        }
        if(chunksize &gt;= targetChunkSize + MIN_CHUNKSIZE)
        {
            // 切割，将剩余的存到链表中
            void* remainChunk = splitChunk(newptr, targetChunkSize);
            PRINT_BLOCK(HD2MEM(newptr), copySize, &quot;After Split:&quot;);
            insertChunk2List(remainChunk);
        }

        PRINT_BLOCK(HD2MEM(newptr), copySize, &quot;After All:&quot;);
    }
    return HD2MEM(newptr);
}
</code></pre>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>今天是第11周的末尾，也是交作业的时刻，然后我还有 proxy lab 没写。而且其他lab也是借着别人的代码自己领会的。觉得效果可能并不是那么明显。没写完的女装，呜呜。正经人谁会有女装照片hhhh</p>
<p>后续自己多返回来看看吧。</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论嗷。 </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">💰</a>
</p>




    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: '1ce498b97d2ce45eead3',
            clientSecret: 'b9ceb4618f0ef4fa4abe92ef21a5c7d2b2fbc9cb',
            repo: 'ccjacoo.github.io',
            owner: 'ccjacoo',
            admin: ['ccjacoo'],
            id: decodeURI(location.pathname),
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('10',10)
        })
        gitalk.render('comments')
    })
</script>




    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2020 sixpar
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().trim().split('\n').length, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: ;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #ECEAEA;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.5;
        background: url("https://i.loli.net/2020/07/04/kPifeO4vhSjdqE5.jpg");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
